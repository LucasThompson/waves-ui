/**
* @author Robert Eisele <robert@xarg.org>
* @copyright Copyright (c) 2010, Robert Eisele
* @link http://www.xarg.org/2010/03/generate-client-side-png-files-using-javascript/
* @license http://www.opensource.org/licenses/bsd-license.php BSD License
*/
"use strict";

var _createClass = require("babel-runtime/helpers/create-class")["default"];

var _classCallCheck = require("babel-runtime/helpers/class-call-check")["default"];

Object.defineProperty(exports, "__esModule", {
  value: true
});

var PNGEncoder = (function () {
  function PNGEncoder(width, height, depth) {
    _classCallCheck(this, PNGEncoder);

    this.width = width;
    this.height = height;
    this.depth = depth;

    // pixel data and row filter identifier size
    this.pix_size = height * (width + 1);

    // deflate header, pix_size, block headers, adler32 checksum
    this.data_size = 2 + this.pix_size + 5 * Math.floor((0xfffe + this.pix_size) / 0xffff) + 4;

    // offsets and sizes of Png chunks
    this.ihdr_offs = 0; // IHDR offset and size
    this.ihdr_size = 4 + 4 + 13 + 4;
    this.plte_offs = this.ihdr_offs + this.ihdr_size; // PLTE offset and size
    this.plte_size = 4 + 4 + 3 * depth + 4;
    this.trns_offs = this.plte_offs + this.plte_size; // tRNS offset and size
    this.trns_size = 4 + 4 + depth + 4;
    this.idat_offs = this.trns_offs + this.trns_size; // IDAT offset and size
    this.idat_size = 4 + 4 + this.data_size + 4;
    this.iend_offs = this.idat_offs + this.idat_size; // IEND offset and size
    this.iend_size = 4 + 4 + 4;
    this.buffer_size = this.iend_offs + this.iend_size; // total PNG size

    this.buffer = [];
    this.palette = {};
    this.pindex = 0;

    var _crc32 = [];

    var i;

    // initialize buffer with zero bytes
    for (i = 0; i < this.buffer_size; i++) {
      this.buffer[i] = "\x00";
    }

    // initialize non-zero elements
    PNGEncoder._write(this.buffer, this.ihdr_offs, PNGEncoder._byte4(this.ihdr_size - 12), 'IHDR', PNGEncoder._byte4(width), PNGEncoder._byte4(height), "\x08\x03");
    PNGEncoder._write(this.buffer, this.plte_offs, PNGEncoder._byte4(this.plte_size - 12), 'PLTE');
    PNGEncoder._write(this.buffer, this.trns_offs, PNGEncoder._byte4(this.trns_size - 12), 'tRNS');
    PNGEncoder._write(this.buffer, this.idat_offs, PNGEncoder._byte4(this.idat_size - 12), 'IDAT');
    PNGEncoder._write(this.buffer, this.iend_offs, PNGEncoder._byte4(this.iend_size - 12), 'IEND');

    // initialize deflate header
    var header = 8 + (7 << 4) << 8 | 3 << 6;
    header += 31 - header % 31;

    PNGEncoder._write(this.buffer, this.idat_offs + 8, PNGEncoder._byte2(header));

    // initialize deflate block headers
    for (i = 0; (i << 16) - 1 < this.pix_size; i++) {
      var size, bits;
      if (i + 0xffff < this.pix_size) {
        size = 0xffff;
        bits = "\x00";
      } else {
        size = this.pix_size - (i << 16) - i;
        bits = "\x01";
      }
      PNGEncoder._write(this.buffer, this.idat_offs + 8 + 2 + (i << 16) + (i << 2), bits, PNGEncoder._byte2lsb(size), PNGEncoder._byte2lsb(~size));
    }

    /* Create crc32 lookup table */
    for (i = 0; i < 256; i++) {
      var c = i;
      for (var j = 0; j < 8; j++) {
        if (c & 1) {
          c = -306674912 ^ c >> 1 & 0x7fffffff;
        } else {
          c = c >> 1 & 0x7fffffff;
        }
      }
      _crc32[i] = c;
    }

    this._crc32 = _crc32;
  }

  _createClass(PNGEncoder, [{
    key: "index",

    // compute the index into a png for a given pixel
    value: function index(x, y) {
      var i = y * (this.width + 1) + x + 1;
      var j = this.idat_offs + 8 + 2 + 5 * Math.floor(i / 0xffff + 1) + i;
      return j;
    }

    // convert a color and build up the palette
  }, {
    key: "color",
    value: function color(red, green, blue, alpha) {

      alpha = alpha >= 0 ? alpha : 255;
      var color = ((alpha << 8 | red) << 8 | green) << 8 | blue;

      if (typeof this.palette[color] == "undefined") {
        if (this.pindex == this.depth) return "\x00";

        var ndx = this.plte_offs + 8 + 3 * this.pindex;

        this.buffer[ndx + 0] = String.fromCharCode(red);
        this.buffer[ndx + 1] = String.fromCharCode(green);
        this.buffer[ndx + 2] = String.fromCharCode(blue);
        this.buffer[this.trns_offs + 8 + this.pindex] = String.fromCharCode(alpha);

        this.palette[color] = String.fromCharCode(this.pindex++);

        //      console.log("Added colour [" + red + "," + green + "," + blue +
        //                  "], palette now has " + this.pindex + " colour(s)");
      }
      return this.palette[color];
    }

    // output a PNG string, Base64 encoded
  }, {
    key: "getBase64",
    value: function getBase64() {

      var s = this.getDump();

      // If the current browser supports the Base64 encoding
      // function, then offload the that to the browser as it
      // will be done in native code.
      if (typeof window.btoa !== 'undefined' && window.btoa !== null) {
        return window.btoa(s);
      }

      var ch = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
      var c1, c2, c3, e1, e2, e3, e4;
      var l = s.length;
      var i = 0;
      var r = "";

      do {
        c1 = s.charCodeAt(i);
        e1 = c1 >> 2;
        c2 = s.charCodeAt(i + 1);
        e2 = (c1 & 3) << 4 | c2 >> 4;
        c3 = s.charCodeAt(i + 2);
        if (l < i + 2) {
          e3 = 64;
        } else {
          e3 = (c2 & 0xf) << 2 | c3 >> 6;
        }
        if (l < i + 3) {
          e4 = 64;
        } else {
          e4 = c3 & 0x3f;
        }
        r += ch.charAt(e1) + ch.charAt(e2) + ch.charAt(e3) + ch.charAt(e4);
      } while ((i += 3) < l);
      return r;
    }

    // output a PNG string
  }, {
    key: "getDump",
    value: function getDump() {

      // compute adler32 of output pixels + row filter bytes
      var BASE = 65521; /* largest prime smaller than 65536 */
      var NMAX = 5552; /* NMAX is the largest n such that 255n(n+1)/2 + (n+1)(BASE-1) <= 2^32-1 */
      var s1 = 1;
      var s2 = 0;
      var n = NMAX;

      for (var y = 0; y < this.height; y++) {
        for (var x = -1; x < this.width; x++) {
          s1 += this.buffer[this.index(x, y)].charCodeAt(0);
          s2 += s1;
          if ((n -= 1) === 0) {
            s1 %= BASE;
            s2 %= BASE;
            n = NMAX;
          }
        }
      }
      s1 %= BASE;
      s2 %= BASE;
      PNGEncoder._write(this.buffer, this.idat_offs + this.idat_size - 8, PNGEncoder._byte4(s2 << 16 | s1));

      // compute crc32 of the PNG chunks
      function crc32(png, offs, size, crctable) {
        var crc = -1;
        for (var i = 4; i < size - 4; i += 1) {
          crc = crctable[(crc ^ png[offs + i].charCodeAt(0)) & 0xff] ^ crc >> 8 & 0x00ffffff;
        }
        PNGEncoder._write(png, offs + size - 4, PNGEncoder._byte4(crc ^ -1));
      }

      crc32(this.buffer, this.ihdr_offs, this.ihdr_size, this._crc32);
      crc32(this.buffer, this.plte_offs, this.plte_size, this._crc32);
      crc32(this.buffer, this.trns_offs, this.trns_size, this._crc32);
      crc32(this.buffer, this.idat_offs, this.idat_size, this._crc32);
      crc32(this.buffer, this.iend_offs, this.iend_size, this._crc32);

      // convert PNG to string
      return "\x89PNG\r\n\x1a\n" + this.buffer.join('');
    }
  }], [{
    key: "_write",
    value: function _write(buffer, offs) {
      for (var i = 2; i < arguments.length; i++) {
        for (var j = 0; j < arguments[i].length; j++) {
          buffer[offs++] = arguments[i].charAt(j);
        }
      }
    }
  }, {
    key: "_byte2",
    value: function _byte2(w) {
      return String.fromCharCode(w >> 8 & 255, w & 255);
    }
  }, {
    key: "_byte4",
    value: function _byte4(w) {
      return String.fromCharCode(w >> 24 & 255, w >> 16 & 255, w >> 8 & 255, w & 255);
    }
  }, {
    key: "_byte2lsb",
    value: function _byte2lsb(w) {
      return String.fromCharCode(w & 255, w >> 8 & 255);
    }
  }]);

  return PNGEncoder;
})();

exports["default"] = PNGEncoder;
module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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Q0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDL0YsY0FBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQy9GLGNBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUMvRixjQUFVLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7OztBQUcvRixRQUFJLE1BQU0sR0FBRyxBQUFDLEFBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUEsQUFBQyxJQUFLLENBQUMsR0FBSyxDQUFDLElBQUksQ0FBQyxBQUFDLENBQUM7QUFDOUMsVUFBTSxJQUFHLEVBQUUsR0FBSSxNQUFNLEdBQUcsRUFBRSxBQUFDLENBQUM7O0FBRTVCLGNBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsRUFBRSxVQUFVLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7OztBQUc5RSxTQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFBLEdBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDOUMsVUFBSSxJQUFJLEVBQUUsSUFBSSxDQUFDO0FBQ2YsVUFBSSxDQUFDLEdBQUcsTUFBTSxHQUFHLElB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QyxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQ25ELGdCQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2xDO09BQ0Y7S0FDRjs7O1dBRVksZ0JBQUMsQ0FBQyxFQUFFO0FBQ2YsYUFBTyxNQUFNLENBQUMsWUFBWSxDQUFDLEFBQUMsQ0FBQyxJQUFJLENBQUMsR0FBSSxHQUFHLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDO0tBQ3JEOzs7V0FFWSxnQkFBQyxDQUFDLEVBQUU7QUFDZixhQUFPLE1BQU0sQ0FBQyxZQUFZLENBQUMsQUFBQyxDQUFDLElBQUksRUFBRSxHQUFJLEdBQUcsRUFBRSxBQUFDLENBQUMsSUFBSSxFQUFFLEdBQUksR0FBRyxFQUFFLEFBQUMsQ0FBQyxJQUFJLENBQUMsR0FBSSxHQUFHLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDO0tBQ3ZGOzs7V0FFZSxtQkFBQyxDQUFDLEVBQUU7QUFDbEIsYUFBTyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsR0FBRyxHQUFHLEVBQUUsQUFBQyxDQUFDLElBQUksQ0FBQyxHQUFJLEdBQUcsQ0FBQyxDQUFDO0tBQ3JEOzs7U0FwR2tCLFVBQVU7OztxQkFBVixVQUFVIiwiZmlsZSI6InNyYy91dGlscy9wbmcuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiogQGF1dGhvciBSb2JlcnQgRWlzZWxlIDxyb2JlcnRAeGFyZy5vcmc+XG4qIEBjb3B5cmlnaHQgQ29weXJpZ2h0IChjKSAyMDEwLCBSb2JlcnQgRWlzZWxlXG4qIEBsaW5rIGh0dHA6Ly93d3cueGFyZy5vcmcvMjAxMC8wMy9nZW5lcmF0ZS1jbGllbnQtc2lkZS1wbmctZmlsZXMtdXNpbmctamF2YXNjcmlwdC9cbiogQGxpY2Vuc2UgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9ic2QtbGljZW5zZS5waHAgQlNEIExpY2Vuc2VcbiovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQTkdFbmNvZGVyIHtcblxuICBjb25zdHJ1Y3Rvcih3aWR0aCwgaGVpZ2h0LCBkZXB0aCkge1xuXG4gICAgdGhpcy53aWR0aCAgID0gd2lkdGg7XG4gICAgdGhpcy5oZWlnaHQgID0gaGVpZ2h0O1xuICAgIHRoaXMuZGVwdGggICA9IGRlcHRoO1xuXG4gICAgLy8gcGl4ZWwgZGF0YSBhbmQgcm93IGZpbHRlciBpZGVudGlmaWVyIHNpemVcbiAgICB0aGlzLnBpeF9zaXplID0gaGVpZ2h0ICogKHdpZHRoICsgMSk7XG5cbiAgICAvLyBkZWZsYXRlIGhlYWRlciwgcGl4X3NpemUsIGJsb2NrIGhlYWRlcnMsIGFkbGVyMzIgY2hlY2tzdW1cbiAgICB0aGlzLmRhdGFfc2l6ZSA9IDIgKyB0aGlzLnBpeF9zaXplICsgNSAqIE1hdGguZmxvb3IoKDB4ZmZmZSArIHRoaXMucGl4X3NpemUpIC8gMHhmZmZmKSArIDQ7XG5cbiAgICAvLyBvZmZzZXRzIGFuZCBzaXplcyBvZiBQbmcgY2h1bmtzXG4gICAgdGhpcy5paGRyX29mZnMgPSAwOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSUhEUiBvZmZzZXQgYW5kIHNpemVcbiAgICB0aGlzLmloZHJfc2l6ZSA9IDQgKyA0ICsgMTMgKyA0O1xuICAgIHRoaXMucGx0ZV9vZmZzID0gdGhpcy5paGRyX29mZnMgKyB0aGlzLmloZHJfc2l6ZTtcdC8vIFBMVEUgb2Zmc2V0IGFuZCBzaXplXG4gICAgdGhpcy5wbHRlX3NpemUgPSA0ICsgNCArIDMgKiBkZXB0aCArIDQ7XG4gICAgdGhpcy50cm5zX29mZnMgPSB0aGlzLnBsdGVfb2ZmcyArIHRoaXMucGx0ZV9zaXplO1x0Ly8gdFJOUyBvZmZzZXQgYW5kIHNpemVcbiAgICB0aGlzLnRybnNfc2l6ZSA9IDQgKyA0ICsgZGVwdGggKyA0O1xuICAgIHRoaXMuaWRhdF9vZmZzID0gdGhpcy50cm5zX29mZnMgKyB0aGlzLnRybnNfc2l6ZTtcdC8vIElEQVQgb2Zmc2V0IGFuZCBzaXplXG4gICAgdGhpcy5pZGF0X3NpemUgPSA0ICsgNCArIHRoaXMuZGF0YV9zaXplICsgNDtcbiAgICB0aGlzLmllbmRfb2ZmcyA9IHRoaXMuaWRhdF9vZmZzICsgdGhpcy5pZGF0X3NpemU7XHQvLyBJRU5EIG9mZnNldCBhbmQgc2l6ZVxuICAgIHRoaXMuaWVuZF9zaXplID0gNCArIDQgKyA0O1xuICAgIHRoaXMuYnVmZmVyX3NpemUgID0gdGhpcy5pZW5kX29mZnMgKyB0aGlzLmllbmRfc2l6ZTtcdC8vIHRvdGFsIFBORyBzaXplXG5cbiAgICB0aGlzLmJ1ZmZlciAgPSBbXTtcbiAgICB0aGlzLnBhbGV0dGUgPSB7fTtcbiAgICB0aGlzLnBpbmRleCAgPSAwO1xuXG4gICAgdmFyIF9jcmMzMiA9IFtdO1xuXG4gICAgdmFyIGk7XG4gICAgXG4gICAgLy8gaW5pdGlhbGl6ZSBidWZmZXIgd2l0aCB6ZXJvIGJ5dGVzXG4gICAgZm9yIChpID0gMDsgaSA8IHRoaXMuYnVmZmVyX3NpemU7IGkrKykge1xuICAgICAgdGhpcy5idWZmZXJbaV0gPSBcIlxceDAwXCI7XG4gICAgfVxuXG4gICAgLy8gaW5pdGlhbGl6ZSBub24temVybyBlbGVtZW50c1xuICAgIFBOR0VuY29kZXIuX3dyaXRlKHRoaXMuYnVmZmVyLCB0aGlzLmloZHJfb2ZmcywgUE5HRW5jb2Rlci5fYnl0ZTQodGhpcy5paGRyX3NpemUgLSAxMiksICdJSERSJywgUE5HRW5jb2Rlci5fYnl0ZTQod2lkdGgpLCBQTkdFbmNvZGVyLl9ieXRlNChoZWlnaHQpLCBcIlxceDA4XFx4MDNcIik7XG4gICAgUE5HRW5jb2Rlci5fd3JpdGUodGhpcy5idWZmZXIsIHRoaXMucGx0ZV9vZmZzLCBQTkdFbmNvZGVyLl9ieXRlNCh0aGlzLnBsdGVfc2l6ZSAtIDEyKSwgJ1BMVEUnKTtcbiAgICBQTkdFbmNvZGVyLl93cml0ZSh0aGlzLmJ1ZmZlciwgdGhpcy50cm5zX29mZnMsIFBOR0VuY29kZXIuX2J5dGU0KHRoaXMudHJuc19zaXplIC0gMTIpLCAndFJOUycpO1xuICAgIFBOR0VuY29kZXIuX3dyaXRlKHRoaXMuYnVmZmVyLCB0aGlzLmlkYXRfb2ZmcywgUE5HRW5jb2Rlci5fYnl0ZTQodGhpcy5pZGF0X3NpemUgLSAxMiksICdJREFUJyk7XG4gICAgUE5HRW5jb2Rlci5fd3JpdGUodGhpcy5idWZmZXIsIHRoaXMuaWVuZF9vZmZzLCBQTkdFbmNvZGVyLl9ieXRlNCh0aGlzLmllbmRfc2l6ZSAtIDEyKSwgJ0lFTkQnKTtcblxuICAgIC8vIGluaXRpYWxpemUgZGVmbGF0ZSBoZWFkZXJcbiAgICB2YXIgaGVhZGVyID0gKCg4ICsgKDcgPDwgNCkpIDw8IDgpIHwgKDMgPDwgNik7XG4gICAgaGVhZGVyKz0gMzEgLSAoaGVhZGVyICUgMzEpO1xuXG4gICAgUE5HRW5jb2Rlci5fd3JpdGUodGhpcy5idWZmZXIsIHRoaXMuaWRhdF9vZmZzICsgOCwgUE5HRW5jb2Rlci5fYnl0ZTIoaGVhZGVyKSk7XG5cbiAgICAvLyBpbml0aWFsaXplIGRlZmxhdGUgYmxvY2sgaGVhZGVyc1xuICAgIGZvciAoaSA9IDA7IChpIDw8IDE2KSAtIDEgPCB0aGlzLnBpeF9zaXplOyBpKyspIHtcbiAgICAgIHZhciBzaXplLCBiaXRzO1xuICAgICAgaWYgKGkgKyAweGZmZmYgPCB0aGlzLnBpeF9zaXplKSB7XG5cdHNpemUgPSAweGZmZmY7XG5cdGJpdHMgPSBcIlxceDAwXCI7XG4gICAgICB9IGVsc2Uge1xuXHRzaXplID0gdGhpcy5waXhfc2l6ZSAtIChpIDw8IDE2KSAtIGk7XG5cdGJpdHMgPSBcIlxceDAxXCI7XG4gICAgICB9XG4gICAgICBQTkdFbmNvZGVyLl93cml0ZSh0aGlzLmJ1ZmZlciwgdGhpcy5pZGF0X29mZnMgKyA4ICsgMiArIChpIDw8IDE2KSArIChpIDw8IDIpLCBiaXRzLCBQTkdFbmNvZGVyLl9ieXRlMmxzYihzaXplKSwgUE5HRW5jb2Rlci5fYnl0ZTJsc2IofnNpemUpKTtcbiAgICB9XG5cbiAgICAvKiBDcmVhdGUgY3JjMzIgbG9va3VwIHRhYmxlICovXG4gICAgZm9yIChpID0gMDsgaSA8IDI1NjsgaSsrKSB7XG4gICAgICB2YXIgYyA9IGk7XG4gICAgICBmb3IgKHZhciBqID0gMDsgaiA8IDg7IGorKykge1xuXHRpZiAoYyAmIDEpIHtcblx0ICBjID0gLTMwNjY3NDkxMiBeICgoYyA+PiAxKSAmIDB4N2ZmZmZmZmYpO1xuXHR9IGVsc2Uge1xuXHQgIGMgPSAoYyA+PiAxKSAmIDB4N2ZmZmZmZmY7XG5cdH1cbiAgICAgIH1cbiAgICAgIF9jcmMzMltpXSA9IGM7XG4gICAgfVxuXG4gICAgdGhpcy5fY3JjMzIgPSBfY3JjMzI7XG4gIH1cbiAgXG4gIHN0YXRpYyBfd3JpdGUoYnVmZmVyLCBvZmZzKSB7XG4gICAgZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXJndW1lbnRzW2ldLmxlbmd0aDsgaisrKSB7XG5cdGJ1ZmZlcltvZmZzKytdID0gYXJndW1lbnRzW2ldLmNoYXJBdChqKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzdGF0aWMgX2J5dGUyKHcpIHtcbiAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSgodyA+PiA4KSAmIDI1NSwgdyAmIDI1NSk7XG4gIH1cblxuICBzdGF0aWMgX2J5dGU0KHcpIHtcbiAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSgodyA+PiAyNCkgJiAyNTUsICh3ID4+IDE2KSAmIDI1NSwgKHcgPj4gOCkgJiAyNTUsIHcgJiAyNTUpO1xuICB9XG4gIFxuICBzdGF0aWMgX2J5dGUybHNiKHcpIHtcbiAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSh3ICYgMjU1LCAodyA+PiA4KSAmIDI1NSk7XG4gIH1cblxuICAvLyBjb21wdXRlIHRoZSBpbmRleCBpbnRvIGEgcG5nIGZvciBhIGdpdmVuIHBpeGVsXG4gIGluZGV4KHgseSkge1xuICAgIHZhciBpID0geSAqICh0aGlzLndpZHRoICsgMSkgKyB4ICsgMTtcbiAgICB2YXIgaiA9IHRoaXMuaWRhdF9vZmZzICsgOCArIDIgKyA1ICogTWF0aC5mbG9vcigoaSAvIDB4ZmZmZikgKyAxKSArIGk7XG4gICAgcmV0dXJuIGo7XG4gIH1cblxuICAvLyBjb252ZXJ0IGEgY29sb3IgYW5kIGJ1aWxkIHVwIHRoZSBwYWxldHRlXG4gIGNvbG9yKHJlZCwgZ3JlZW4sIGJsdWUsIGFscGhhKSB7XG4gICAgICBcbiAgICBhbHBoYSA9IGFscGhhID49IDAgPyBhbHBoYSA6IDI1NTtcbiAgICB2YXIgY29sb3IgPSAoKCgoKGFscGhhIDw8IDgpIHwgcmVkKSA8PCA4KSB8IGdyZWVuKSA8PCA4KSB8IGJsdWU7XG4gICAgICBcbiAgICBpZiAodHlwZW9mIHRoaXMucGFsZXR0ZVtjb2xvcl0gPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgaWYgKHRoaXMucGluZGV4ID09IHRoaXMuZGVwdGgpIHJldHVybiBcIlxceDAwXCI7XG4gICAgICBcbiAgICAgIHZhciBuZHggPSB0aGlzLnBsdGVfb2ZmcyArIDggKyAzICogdGhpcy5waW5kZXg7XG4gICAgICBcbiAgICAgIHRoaXMuYnVmZmVyW25keCArIDBdID0gU3RyaW5nLmZyb21DaGFyQ29kZShyZWQpO1xuICAgICAgdGhpcy5idWZmZXJbbmR4ICsgMV0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGdyZWVuKTtcbiAgICAgIHRoaXMuYnVmZmVyW25keCArIDJdID0gU3RyaW5nLmZyb21DaGFyQ29kZShibHVlKTtcbiAgICAgIHRoaXMuYnVmZmVyW3RoaXMudHJuc19vZmZzKzgrdGhpcy5waW5kZXhdID0gU3RyaW5nLmZyb21DaGFyQ29kZShhbHBoYSk7XG4gICAgICBcbiAgICAgIHRoaXMucGFsZXR0ZVtjb2xvcl0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHRoaXMucGluZGV4KyspO1xuXG4vLyAgICAgIGNvbnNvbGUubG9nKFwiQWRkZWQgY29sb3VyIFtcIiArIHJlZCArIFwiLFwiICsgZ3JlZW4gKyBcIixcIiArIGJsdWUgK1xuLy8gICAgICAgICAgICAgICAgICBcIl0sIHBhbGV0dGUgbm93IGhhcyBcIiArIHRoaXMucGluZGV4ICsgXCIgY29sb3VyKHMpXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wYWxldHRlW2NvbG9yXTtcbiAgfVxuXG4gIC8vIG91dHB1dCBhIFBORyBzdHJpbmcsIEJhc2U2NCBlbmNvZGVkXG4gIGdldEJhc2U2NCgpIHtcbiAgICAgIFxuICAgIHZhciBzID0gdGhpcy5nZXREdW1wKCk7XG4gICAgICBcbiAgICAvLyBJZiB0aGUgY3VycmVudCBicm93c2VyIHN1cHBvcnRzIHRoZSBCYXNlNjQgZW5jb2RpbmdcbiAgICAvLyBmdW5jdGlvbiwgdGhlbiBvZmZsb2FkIHRoZSB0aGF0IHRvIHRoZSBicm93c2VyIGFzIGl0XG4gICAgLy8gd2lsbCBiZSBkb25lIGluIG5hdGl2ZSBjb2RlLlxuICAgIGlmICgodHlwZW9mIHdpbmRvdy5idG9hICE9PSAndW5kZWZpbmVkJykgJiYgKHdpbmRvdy5idG9hICE9PSBudWxsKSkge1xuICAgICAgcmV0dXJuIHdpbmRvdy5idG9hKHMpO1xuICAgIH1cbiAgICBcbiAgICB2YXIgY2ggPSBcIkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky89XCI7XG4gICAgdmFyIGMxLCBjMiwgYzMsIGUxLCBlMiwgZTMsIGU0O1xuICAgIHZhciBsID0gcy5sZW5ndGg7XG4gICAgdmFyIGkgPSAwO1xuICAgIHZhciByID0gXCJcIjtcbiAgICBcbiAgICBkbyB7XG4gICAgICBjMSA9IHMuY2hhckNvZGVBdChpKTtcbiAgICAgIGUxID0gYzEgPj4gMjtcbiAgICAgIGMyID0gcy5jaGFyQ29kZUF0KGkrMSk7XG4gICAgICBlMiA9ICgoYzEgJiAzKSA8PCA0KSB8IChjMiA+PiA0KTtcbiAgICAgIGMzID0gcy5jaGFyQ29kZUF0KGkrMik7XG4gICAgICBpZiAobCA8IGkrMikgeyBlMyA9IDY0OyB9IGVsc2UgeyBlMyA9ICgoYzIgJiAweGYpIDw8IDIpIHwgKGMzID4+IDYpOyB9XG4gICAgICBpZiAobCA8IGkrMykgeyBlNCA9IDY0OyB9IGVsc2UgeyBlNCA9IGMzICYgMHgzZjsgfVxuICAgICAgcis9IGNoLmNoYXJBdChlMSkgKyBjaC5jaGFyQXQoZTIpICsgY2guY2hhckF0KGUzKSArIGNoLmNoYXJBdChlNCk7XG4gICAgfSB3aGlsZSAoKGkrPSAzKSA8IGwpO1xuICAgIHJldHVybiByO1xuICB9XG5cbiAgLy8gb3V0cHV0IGEgUE5HIHN0cmluZ1xuICBnZXREdW1wKCkge1xuXG4gICAgLy8gY29tcHV0ZSBhZGxlcjMyIG9mIG91dHB1dCBwaXhlbHMgKyByb3cgZmlsdGVyIGJ5dGVzXG4gICAgdmFyIEJBU0UgPSA2NTUyMTsgLyogbGFyZ2VzdCBwcmltZSBzbWFsbGVyIHRoYW4gNjU1MzYgKi9cbiAgICB2YXIgTk1BWCA9IDU1NTI7ICAvKiBOTUFYIGlzIHRoZSBsYXJnZXN0IG4gc3VjaCB0aGF0IDI1NW4obisxKS8yICsgKG4rMSkoQkFTRS0xKSA8PSAyXjMyLTEgKi9cbiAgICB2YXIgczEgPSAxO1xuICAgIHZhciBzMiA9IDA7XG4gICAgdmFyIG4gPSBOTUFYO1xuXG4gICAgZm9yICh2YXIgeSA9IDA7IHkgPCB0aGlzLmhlaWdodDsgeSsrKSB7XG4gICAgICBmb3IgKHZhciB4ID0gLTE7IHggPCB0aGlzLndpZHRoOyB4KyspIHtcblx0czErPSB0aGlzLmJ1ZmZlclt0aGlzLmluZGV4KHgsIHkpXS5jaGFyQ29kZUF0KDApO1xuXHRzMis9IHMxO1xuXHRpZiAoKG4tPSAxKSA9PT0gMCkge1xuXHQgIHMxJT0gQkFTRTtcblx0ICBzMiU9IEJBU0U7XG5cdCAgbiA9IE5NQVg7XG5cdH1cbiAgICAgIH1cbiAgICB9XG4gICAgczElPSBCQVNFO1xuICAgIHMyJT0gQkFTRTtcbiAgICBQTkdFbmNvZGVyLl93cml0ZSh0aGlzLmJ1ZmZlciwgdGhpcy5pZGF0X29mZnMgKyB0aGlzLmlkYXRfc2l6ZSAtIDgsIFBOR0VuY29kZXIuX2J5dGU0KChzMiA8PCAxNikgfCBzMSkpO1xuICAgIFxuICAgIC8vIGNvbXB1dGUgY3JjMzIgb2YgdGhlIFBORyBjaHVua3NcbiAgICBmdW5jdGlvbiBjcmMzMihwbmcsIG9mZnMsIHNpemUsIGNyY3RhYmxlKSB7XG4gICAgICB2YXIgY3JjID0gLTE7XG4gICAgICBmb3IgKHZhciBpID0gNDsgaSA8IHNpemUtNDsgaSArPSAxKSB7XG5cdGNyYyA9IGNyY3RhYmxlWyhjcmMgXiBwbmdbb2ZmcytpXS5jaGFyQ29kZUF0KDApKSAmIDB4ZmZdIF4gKChjcmMgPj4gOCkgJiAweDAwZmZmZmZmKTtcbiAgICAgIH1cbiAgICAgIFBOR0VuY29kZXIuX3dyaXRlKHBuZywgb2ZmcytzaXplLTQsIFBOR0VuY29kZXIuX2J5dGU0KGNyYyBeIC0xKSk7XG4gICAgfVxuICAgIFxuICAgIGNyYzMyKHRoaXMuYnVmZmVyLCB0aGlzLmloZHJfb2ZmcywgdGhpcy5paGRyX3NpemUsIHRoaXMuX2NyYzMyKTtcbiAgICBjcmMzMih0aGlzLmJ1ZmZlciwgdGhpcy5wbHRlX29mZnMsIHRoaXMucGx0ZV9zaXplLCB0aGlzLl9jcmMzMik7XG4gICAgY3JjMzIodGhpcy5idWZmZXIsIHRoaXMudHJuc19vZmZzLCB0aGlzLnRybnNfc2l6ZSwgdGhpcy5fY3JjMzIpO1xuICAgIGNyYzMyKHRoaXMuYnVmZmVyLCB0aGlzLmlkYXRfb2ZmcywgdGhpcy5pZGF0X3NpemUsIHRoaXMuX2NyYzMyKTtcbiAgICBjcmMzMih0aGlzLmJ1ZmZlciwgdGhpcy5pZW5kX29mZnMsIHRoaXMuaWVuZF9zaXplLCB0aGlzLl9jcmMzMik7XG4gICAgXG4gICAgLy8gY29udmVydCBQTkcgdG8gc3RyaW5nXG4gICAgcmV0dXJuIFwiXFx4ODlQTkdcXHJcXG5cXHgxYVxcblwiK3RoaXMuYnVmZmVyLmpvaW4oJycpO1xuICB9XG4gIFxufVxuXG5cblxuIl19