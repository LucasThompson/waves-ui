<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Spectrogram Layer</title>

    <link rel="stylesheet" type="text/css" href="./assets/common.css" />
    <link rel="stylesheet" type="text/css" href="./assets/prism.css" />

    <script src="../waves-ui.umd.js"></script>
    <script src="./assets/prism.js"></script>
    <script src="./assets/insert-code.js"></script>
</head>
<body>

<h1>Spectrogram Layer</h1>

<!-- SIMPLE USAGE -->
<h2 id="simple-use">Simple Usage</h2>

<div class="track" id="track-1">
<canvas id="external-canvas"></canvas>

</div>



<script class="example" rel="track-1">
  // We need some spectrogram like data, get it from a JSON file for simplicity
  function readFile(url) {
    return new Promise(res => {
      let request = new XMLHttpRequest();
      request.addEventListener('load', (response) => res(JSON.parse(response.target.responseText)));
      request.open('GET', url);
      request.send();
    });
  }

  function drawSpectrogram(features, $track, width, height) {
    // define the number of pixels per second the timeline should display
    const duration = 3.4784581661224365;
    const pixelsPerSecond = width / duration;
    let timeline = new wavesUI.core.NotifyingTimeline(pixelsPerSecond, width);

    timeline.on('visibleExtentsChanged', (ev) => {
      console.log(ev);
    });

    timeline.createTrack($track, height, 'main');

    // time axis
    const timeAxis = new wavesUI.helpers.TimeAxisLayer({
      height: height,
      color: 'gray'
    });
    timeline.addLayer(timeAxis, 'main', timeline.timeContext, true);

    // segment
    const segmentLayer = new wavesUI.helpers.SegmentLayer([
      {x: 0, width: duration, opacity: 0.8, color: 'orange'}
    ], {
      height: height,
      displayHandlers: false,
    });

    // insert the layer inside the 'main' track
    timeline.addLayer(segmentLayer, 'main');

    // create the spectrogram layer
    const spectrogramLayer = new wavesUI.helpers.SpectrogramLayer(
      features,
      512 / 44100.0,
      {
        height: height,
        opacity: 1.0
      }
    );
    timeline.state = new wavesUI.states.CenteredZoomState(timeline);
    timeline.addLayer(spectrogramLayer, 'main', timeline.timeContext);
    return timeline;
  }

  const drawFileData = (fileData) => {
    const $track = document.querySelector('#track-1');
    const width = $track.getBoundingClientRect().width;
    const height = 400;
    return drawSpectrogram(fileData.z, $track, width, height);
  };

  const drawExternalCanvas = (timeline) => {
    const $canvas = document.getElementById("external-canvas");
    $canvas.style['position'] = 'absolute';
    $canvas.height = 400;
    const $track = document.querySelector('#track-1');
    $canvas.width = $track.getBoundingClientRect().width;
    const ctx = $canvas.getContext("2d");
    ctx.font = "30px Arial";
    ctx.fillText("Hello World", timeline.timeToPixel(4.0), 50);
    timeline.on('visibleExtentsChanged', (ev) => {
      ctx.clearRect(0, 0, $canvas.width, $canvas.height);
      ctx.fillText("Hello World", timeline.timeToPixel(4.0 - ev.start), 50);
    });
  };

  readFile('assets/drum-loop-spectrogram.json')
    .then(drawFileData)
    .then(drawExternalCanvas)
    .catch((err) => console.log(err));
</script>
</body>
</html>